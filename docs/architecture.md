# Apex Trading Bot - Architecture

> AI 피드백 루프 기반 암호화폐 자동매매 봇

## 🎯 프로젝트 목표

**$1,000 → $10,000** (2026년 상반기, 약 6개월)

- 월 평균 목표 수익률: 35-40% (복리)
- 주요 거래소: Hyperliquid DEX
- 보조 거래소: Bybit CEX

---

## 🏗️ 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────┐
│                         APEX TRADING BOT                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │
│  │   Elysia     │    │   Cron Jobs  │    │  WebSocket   │          │
│  │   REST API   │    │              │    │  (실시간)     │          │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘          │
│         │                   │                   │                   │
│         └───────────────────┼───────────────────┘                   │
│                             │                                       │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     CORE SERVICES                            │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │   │
│  │  │ Indicator   │ │ Trade       │ │ Global      │            │   │
│  │  │ Service     │ │ History     │ │ Config      │            │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                       │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                   AI FEEDBACK LOOP                           │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │  Trigger → Analyze → Recommend → Apply → Monitor    │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                       │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    TRADING STRATEGIES                        │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐   │   │
│  │  │ Grid Bot  │ │ Momentum  │ │ Scalping  │ │ Funding   │   │   │
│  │  │   40%     │ │   30%     │ │   15%     │ │ Arb 10%   │   │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                       │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                   EXCHANGE CLIENTS                           │   │
│  │  ┌─────────────────────┐    ┌─────────────────────┐         │   │
│  │  │    Hyperliquid      │    │     Bybit CEX.      │         │   │
│  │  │    (Primary)        │    │    (Secondary)      │         │   │
│  │  └─────────────────────┘    └─────────────────────┘         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                         EXTERNAL DATA                               │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐          │
│  │ CoinGecko │ │ DeFiLlama │ │ Fear&Greed│ │ Google    │          │
│  │ (Price)   │ │ (TVL)     │ │ (Senti)   │ │ Trends    │          │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘          │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   SQLite DB     │
                    │   (Prisma)      │
                    └─────────────────┘
```

---

## 📁 프로젝트 구조

```
apex/
├── prisma/
│   └── schema.prisma              # DB 스키마 정의
│
├── src/
│   ├── index.ts                   # Elysia 서버 진입점
│   │
│   ├── services/                  # 핵심 비즈니스 로직
│   │   ├── indicators.service.ts      # 기술 지표 계산
│   │   ├── trade-history.service.ts   # 거래 기록 & 분석
│   │   ├── global-config.service.ts   # 전역 설정 관리
│   │   ├── ai-feedback-loop.service.ts # AI 분석 엔진
│   │   └── external-data.service.ts   # 외부 API 연동
│   │
│   ├── strategies/                # 매매 전략
│   │   ├── grid-bot.strategy.ts       # 그리드 봇 (횡보장)
│   │   ├── momentum.strategy.ts       # 모멘텀 (추세장)
│   │   ├── scalping.strategy.ts       # 스캘핑 (단타)
│   │   └── funding-arb.strategy.ts    # 펀딩비 차익
│   │
│   ├── exchanges/                 # 거래소 클라이언트
│   │   ├── hyperliquid.client.ts      # Hyperliquid SDK
│   │   └── lighter.client.ts          # Lighter DEX SDK
│   │
│   ├── api/                       # API 라우트
│   │   └── routes/
│   │       ├── status.ts              # 상태 조회
│   │       ├── trades.ts              # 거래 관리
│   │       ├── strategies.ts          # 전략 관리
│   │       └── ai.ts                  # AI 분석
│   │
│   ├── jobs/                      # 스케줄 작업
│   │   ├── candle-collector.job.ts    # 캔들 수집 (1분)
│   │   ├── sentiment-updater.job.ts   # 센티먼트 (1시간)
│   │   └── daily-snapshot.job.ts      # 일일 스냅샷
│   │
│   └── types/                     # 타입 정의
│       └── index.ts
│
├── docs/
│   ├── ARCHITECTURE.md            # 이 문서
│   └── EXTERNAL_DATA_AND_STRATEGIES.md
│
├── CLAUDE.md                      # AI 어시스턴트용 컨텍스트
├── .cursorrules                   # 코딩 규칙
├── package.json
├── tsconfig.json
└── .env.example
```

---

## 🔄 AI 피드백 루프

### 플로우

```
거래 완료
    │
    ▼
┌─────────────────┐
│  트리거 체크    │
│  - 10개 거래    │
│  - 3연속 손실   │
│  - 10% DD      │
└────────┬────────┘
         │ 트리거 발동
         ▼
┌─────────────────┐
│  컨텍스트 수집  │
│  - 최근 거래    │
│  - 성과 지표    │
│  - 시장 상황    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Claude API     │
│  분석 요청      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  추천사항 파싱  │
│  - 파라미터 조정│
│  - 배분 변경    │
│  - 전략 제어    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  자동 적용      │
│  (±20% 제한)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  결과 로깅      │
│  DB 저장        │
└─────────────────┘
```

### 트리거 조건

| 트리거             | 조건           | 목적             |
| ------------------ | -------------- | ---------------- |
| `trade_count`      | 10개 거래 완료 | 정기 성과 분석   |
| `consecutive_loss` | 3연속 손실     | 긴급 리스크 대응 |
| `drawdown`         | 10% 드로다운   | 자본 보호        |
| `manual`           | API 호출       | 수동 분석        |

### AI 추천 타입

```typescript
type RecommendationType =
  | "adjust_params" // 전략 파라미터 조정 (자동 적용)
  | "adjust_allocation" // 자본 배분 변경 (자동 적용)
  | "pause_strategy" // 전략 일시 중지 (자동 적용)
  | "resume_strategy" // 전략 재개 (자동 적용)
  | "adjust_risk" // 전역 리스크 조정 (자동 적용)
  | "change_strategy"; // 전략 교체 (수동 승인 필요)
```

### 안전장치

- **파라미터 변경 제한**: 한 번에 최대 ±20%
- **Critical 추천**: 수동 승인 필요
- **최소 분석 간격**: 60분
- **낮은 신뢰도**: < 0.5는 자동 적용 스킵

---

## 📊 매매 전략

### 전략별 자본 배분

```
┌─────────────────────────────────────────┐
│            총 자본: $1,000              │
├─────────────────────────────────────────┤
│  Grid Bot     │████████████████│  40%  │  $400
│  Momentum     │████████████    │  30%  │  $300
│  Scalping     │██████          │  15%  │  $150
│  Funding Arb  │████            │  10%  │  $100
│  Reserve      │██              │   5%  │   $50
└─────────────────────────────────────────┘
```

### 1. Grid Bot (그리드 봇)

```
가격 범위: $95,000 ~ $100,000
그리드 수: 10개
레버리지: 3x

$100,000 ─────── SELL ───────
$99,500  ─────── SELL ───────
$99,000  ─────── SELL ───────
   ...         ...
$95,500  ─────── BUY  ───────
$95,000  ─────── BUY  ───────

→ 횡보장에서 자동 매수/매도 반복
→ 예상 수익: 월 5-15%
```

### 2. Momentum (모멘텀)

```
진입 조건:
├─ RSI < 30 (과매도) → LONG
├─ RSI > 70 (과매수) → SHORT
├─ BB 하단 이탈 → LONG
├─ BB 상단 이탈 → SHORT
└─ ADX > 25 (추세 확인)

청산 조건:
├─ Take Profit: +5%
├─ Stop Loss: -2%
└─ Trailing Stop: 2%

→ 추세장에서 큰 움직임 포착
→ 예상 수익: 월 10-30%
```

### 3. Scalping (스캘핑)

```
타임프레임: 1분 / 5분봉
진입: RSI 극단값 (< 25 or > 75)

목표:
├─ Take Profit: +0.3~0.5%
├─ Stop Loss: -0.2~0.3%
├─ 일일 최대 거래: 20회
└─ 일일 최대 손실: $30

→ 짧은 시간 내 빠른 수익
→ 예상 수익: 일 0.5-2%
```

### 4. Funding Rate Arbitrage (펀딩비 차익)

```
조건: 펀딩비 > 0.01%

펀딩비 양수 (+)
└─ Long이 Short에게 지불
└─ → Short 포지션 진입 (펀딩 수령)

펀딩비 음수 (-)
└─ Short이 Long에게 지불
└─ → Long 포지션 진입 (펀딩 수령)

→ 델타 뉴트럴, 저리스크
→ 예상 수익: 월 3-5% (연 36-60% APY)
```

---

## 💾 데이터베이스 스키마

### ERD

```
┌─────────────────┐       ┌─────────────────┐
│     Trade       │       │    Strategy     │
├─────────────────┤       ├─────────────────┤
│ id              │──────▶│ id              │
│ symbol          │       │ name            │
│ side            │       │ type            │
│ entryPrice      │       │ enabled         │
│ exitPrice       │       │ allocation      │
│ pnl             │       │ paramsJson      │
│ exitReason      │       │ winRate         │
│ strategyId (FK) │       │ profitFactor    │
│ indicatorsJson  │       │ totalPnl        │
└─────────────────┘       └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │StrategyParam   │
                          │History         │
                          ├─────────────────┤
                          │ strategyId (FK) │
                          │ previousParams  │
                          │ newParams       │
                          │ changeReason    │
                          │ source          │
                          │ aiConfidence    │
                          └─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│   AIAnalysis    │       │  GlobalConfig   │
├─────────────────┤       ├─────────────────┤
│ triggerType     │       │ initialBalance  │
│ analysisText    │       │ currentBalance  │
│ confidence      │       │ maxDrawdown     │
│ riskLevel       │       │ maxLeverage     │
│ recommendations │       │ aiSettings...   │
│ appliedCount    │       └─────────────────┘
│ inputTokens     │
└─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│ AccountSnapshot │       │  CandleCache    │
├─────────────────┤       ├─────────────────┤
│ date            │       │ symbol          │
│ balance         │       │ timeframe       │
│ equity          │       │ OHLCV data      │
│ dailyPnl        │       │ timestamp       │
│ drawdown        │       └─────────────────┘
└─────────────────┘
```

---

## 🔌 외부 데이터 연동

### API 스택 (무료 조합)

| 용도          | 서비스         | Rate Limit | 엔드포인트               |
| ------------- | -------------- | ---------- | ------------------------ |
| **가격/시장** | CoinGecko      | 30/min     | `api.coingecko.com`      |
| **DeFi/TVL**  | DeFiLlama      | 무제한     | `api.llama.fi`           |
| **센티먼트**  | Alternative.me | 무제한     | `api.alternative.me/fng` |
| **트렌드**    | SerpApi        | 100/월     | `serpapi.com`            |

### 데이터 수집 주기

```
┌─────────────────────────────────────────────────────┐
│                    CRON JOBS                        │
├─────────────────────────────────────────────────────┤
│  매 1분   │ 캔들 데이터 수집, 지표 업데이트          │
│  매 5분   │ 포지션 상태 체크, TP/SL 확인            │
│  매 1시간 │ Fear & Greed Index, 센티먼트 업데이트   │
│  매 8시간 │ 펀딩비 수령 (Hyperliquid)               │
│  매일 0시 │ 일일 스냅샷, 성과 리포트                 │
└─────────────────────────────────────────────────────┘
```

---

## 🚀 API 엔드포인트

### 상태 & 모니터링

| Method | Endpoint               | 설명                       |
| ------ | ---------------------- | -------------------------- |
| GET    | `/health`              | 서버 헬스 체크             |
| GET    | `/status`              | 계정 상태, 리스크, AI 상태 |
| GET    | `/performance?days=30` | 기간별 성과 요약           |

### 거래 관리

| Method | Endpoint                  | 설명             |
| ------ | ------------------------- | ---------------- |
| GET    | `/trades/recent?limit=20` | 최근 거래 조회   |
| GET    | `/trades/open`            | 열린 포지션 조회 |

### 전략 관리

| Method | Endpoint                 | 설명                 |
| ------ | ------------------------ | -------------------- |
| GET    | `/strategies`            | 전략 목록            |
| GET    | `/strategies/:id`        | 전략 상세            |
| POST   | `/strategies/:id/toggle` | 전략 활성화/비활성화 |
| PATCH  | `/strategies/:id/params` | 파라미터 수정        |

### AI 분석

| Method | Endpoint      | 설명                |
| ------ | ------------- | ------------------- |
| POST   | `/ai/analyze` | 수동 AI 분석 트리거 |
| GET    | `/ai/history` | AI 분석 히스토리    |

### 지표 & 시그널

| Method | Endpoint              | 설명             |
| ------ | --------------------- | ---------------- |
| GET    | `/indicators/:symbol` | 기술 지표 스냅샷 |
| GET    | `/signals/:symbol`    | 트레이딩 시그널  |

### 설정

| Method | Endpoint          | 설명                   |
| ------ | ----------------- | ---------------------- |
| GET    | `/config`         | 전역 설정 조회         |
| PATCH  | `/config`         | 전역 설정 수정         |
| GET    | `/history/params` | 파라미터 변경 히스토리 |

---

## 📈 목표 달성 시뮬레이션

### 6개월 로드맵

```
Month 1: $1,000 → $1,400   (+40%)
├─ 봇 안정화 & 테스트
├─ Grid Bot 위주 운영
└─ AI 피드백 루프 검증

Month 2: $1,400 → $1,960   (+40%)
├─ Momentum 전략 활성화
├─ 파라미터 최적화
└─ 신규 토큰 리서치

Month 3: $1,960 → $2,744   (+40%)
├─ 스캘핑 추가
├─ IDO/IEO 1개 참여
└─ 리스크 관리 강화

Month 4: $2,744 → $3,842   (+40%)
├─ 불장 신호 시 공격적 운영
├─ 레버리지 단계적 확대
└─ 센티먼트 기반 타이밍

Month 5: $3,842 → $5,379   (+40%)
├─ 수익 일부 실현
├─ 스테이블 예비금 확보
└─ 과열 구간 모니터링

Month 6: $5,379 → $7,530   (+40%)
├─ + IDO 성공 시 ($2,500)
└─ 총 약 $10,000 달성 🎯
```

### 리스크 시나리오

| 시나리오   | 결과         | 대응                      |
| ---------- | ------------ | ------------------------- |
| **최악**   | -30% DD      | 전략 중지, 원금 $700 보존 |
| **보수적** | 월 20%       | 6개월 후 약 $3,000        |
| **목표**   | 월 40%       | 6개월 후 약 $10,000       |
| **최선**   | 월 50% + IDO | 6개월 후 약 $15,000       |

---

## 🛠️ 기술 스택

| 카테고리       | 기술            | 용도                    |
| -------------- | --------------- | ----------------------- |
| **Runtime**    | Bun             | Node.js 대체, 빠른 실행 |
| **Framework**  | Elysia          | REST API + WebSocket    |
| **Language**   | TypeScript      | 타입 안정성             |
| **Database**   | SQLite + Prisma | 로컬 DB, ORM            |
| **AI**         | Claude API      | 피드백 루프 분석        |
| **Indicators** | trading-signals | 기술 지표 계산          |
| **Exchange**   | hyperliquid-ts  | Hyperliquid SDK         |

---

## 🔐 환경 변수

```env
# 필수
ANTHROPIC_API_KEY=sk-ant-xxx        # Claude API
DATABASE_URL=file:./apex.db         # SQLite 경로

# 거래소
HYPERLIQUID_PRIVATE_KEY=0x...       # 거래 실행용
HYPERLIQUID_WALLET_ADDRESS=0x...

# 옵션
SERPAPI_KEY=xxx                     # Google Trends
PORT=3000                           # 서버 포트
NODE_ENV=development
```

---

## 📝 개발 상태

### ✅ 완료

- [x] 프로젝트 구조 설계
- [x] Prisma 스키마 정의
- [x] 기술 지표 서비스
- [x] 거래 히스토리 서비스
- [x] 전역 설정 서비스
- [x] AI 피드백 루프
- [x] 4가지 전략 로직 설계
- [x] 외부 API 연동 설계
- [x] Elysia 서버 기본 구조
- [x] AI 어시스턴트용 문서

### 🔄 진행 예정

- [ ] Hyperliquid SDK 실제 연동
- [ ] 전략 클래스 구현
- [ ] WebSocket 실시간 데이터
- [ ] Cron Jobs 구현
- [ ] 백테스팅 모듈
- [ ] 텔레그램 알림
- [ ] 대시보드 UI (React)

---

_Last Updated: 2026-01-02_
